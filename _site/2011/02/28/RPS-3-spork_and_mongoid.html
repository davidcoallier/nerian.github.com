<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <title>Nerian Blog: Lighting fast tests with Spork on a Mongoid project</title>
        <link rel="stylesheet" href="/css/master.css">
		<link rel="stylesheet" href="/css/coderay.css">						
    </head>
    <body>        
	
		<div id="wrapper">
	<div id="header">
		<div id='description'>                    
			<span>Gonzalo Rodríguez,</span><br>
			<span>Freelance web developer specialised in Ruby and MongoDB</span>			
		</div>                                                                  
		<hr>
		<div id='actions'>
			<ul>
				<li><a href="/index.html">Blog</a></li>
				<li><a href="/about.html">About</a></li>
				<li><a href="/hireme.html">Hire me</a></li>
				<li><a href="http://careers.stackoverflow.com/nerian" target='_blank'>Curriculum</a></li>				
			</ul>
		</div>		                                                                     
		<hr>
		<div id='external-actions'>
			<ul>
				<li><a href="http://feeds.feedburner.com/Nerian-blog" target='_blank' type="application/rss+xml"><img class='first-image'src="http://www.feedburner.com/fb/images/pub/feed-icon16x16.png" alt="" style="vertical-align:middle;border:0"/> Subscribe </a>&nbsp;</li>
				<li><a href="https://github.com/Nerian" target='_blank'><img class='second-image' STYLE="position:relative; top:9px" height="27" width="27" src="/images/github.png"/> Github</a></li>
				<li><a href="http://www.twitter.com/iCodeErgoExist" target='_blank'><img class='third-image' STYLE="position:relative; top:5px" src="http://twitter-badges.s3.amazonaws.com/t_small-a.png" alt="Seguir a iCodeErgoExist en Twitter"/> Twitter</a></li>
			</ul>			
		</div>		
	</div>
	<div id="content">
		<div class='post'>
			<div>
	<h2><a href="/2011/02/28/RPS-3-spork_and_mongoid.html">Lighting fast tests with Spork on a Mongoid project</a></h2>
	<em>Posted on 28 February 2011</em>
	<br/>
	<div>
		<h3 id="summary">Summary:</h3>

<ul>
  <li>We are going to set up a Rails 3 project using Mongoid and Spork.</li>
  <li>The full project is in <a href="https://github.com/Nerian/Mongoid-spork-Rails-app-example" title="github">github</a></li>
</ul>

<h3 id="introduction">Introduction:</h3>

<p>MongoDB is a document oriented database. To sum it up what it means: Flexibility. </p>

<p>Mongoid is a ORM that harness the power of MongoDB in a very elegant way. Its power lies around a very good documentation and an active community.</p>

<p>Spork is a gem designed to allow you to run your spec very quickly. How does it do that? It preloads your Rails environment. You’ll notice a difference in that your testing starts right away, instead of waiting a few seconds.</p>

<h3 id="create-a-rails-project">Create a Rails project:</h3>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> $ rails new mongoid-spork-example
</pre></div>
</div>
</div>

<p>Configure RVM       </p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> $ cd mongoid-spork-example
<span class="no">2</span> $ echo &quot;rvm gemset create mongoid-example \nrvm gemset use mongoid-example&quot; &gt;&gt; .rvmrc
</pre></div>
</div>
</div>

<p>Configure Gemfile      </p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> gem <span class="s"><span class="dl">'</span><span class="k">rails</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">3.0.4</span><span class="dl">'</span></span>                                                     
<span class="no">2</span> gem <span class="s"><span class="dl">&quot;</span><span class="k">mongoid</span><span class="dl">&quot;</span></span>, <span class="s"><span class="dl">&quot;</span><span class="k">2.0.0.rc.7</span><span class="dl">&quot;</span></span>
<span class="no">3</span> gem <span class="s"><span class="dl">'</span><span class="k">bson_ext</span><span class="dl">'</span></span>
<span class="no">4</span> group <span class="sy">:development</span>, <span class="sy">:test</span> <span class="r">do</span>
<span class="no">5</span>   gem <span class="s"><span class="dl">'</span><span class="k">rspec-rails</span><span class="dl">'</span></span>
<span class="no">6</span>   gem <span class="s"><span class="dl">'</span><span class="k">spork</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">~&gt; 0.9.0.rc</span><span class="dl">'</span></span> <span class="c"># It's important to use the rc version </span>
<span class="no">7</span> <span class="r">end</span>              
</pre></div>
</div>
</div>

<p>Install gems</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> $ bundle install       
</pre></div>
</div>
</div>

<p>Generate mongoid configuration file:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> $ rails generate mongoid:config
</pre></div>
</div>
</div>

<p>Empty config/database.yml</p>

<p>Open config/application and comment the line require ‘rails/all’. Add the rest:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> <span class="c">#require 'rails/all' </span>
<span class="no">2</span> require <span class="s"><span class="dl">&quot;</span><span class="k">action_controller/railtie</span><span class="dl">&quot;</span></span>
<span class="no">3</span> require <span class="s"><span class="dl">&quot;</span><span class="k">action_mailer/railtie</span><span class="dl">&quot;</span></span>
<span class="no">4</span> require <span class="s"><span class="dl">&quot;</span><span class="k">active_resource/railtie</span><span class="dl">&quot;</span></span>
<span class="no">5</span> require <span class="s"><span class="dl">&quot;</span><span class="k">rails/test_unit/railtie</span><span class="dl">&quot;</span></span>  
</pre></div>
</div>
</div>

<p>Run RSpec generator</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> rails g rspec:install
</pre></div>
</div>
</div>

<p>Run the Spork generator. This changes the spec/spec_helper.rb</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> $ spork --bootstrap          
</pre></div>
</div>
</div>

<p>Configure spec/spec_helper.rb</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no"> 1</span> require <span class="s"><span class="dl">'</span><span class="k">rubygems</span><span class="dl">'</span></span>
<span class="no"> 2</span> require <span class="s"><span class="dl">'</span><span class="k">spork</span><span class="dl">'</span></span>
<span class="no"> 3</span> 
<span class="no"> 4</span> <span class="co">Spork</span>.prefork <span class="r">do</span>
<span class="no"> 5</span>   <span class="c"># Loading more in this block will cause your tests to run faster. However,</span>
<span class="no"> 6</span>   <span class="c"># if you change any configuration or code from libraries loaded here, you'll</span>
<span class="no"> 7</span>   <span class="c"># need to restart spork for it take effect.</span>
<span class="no"> 8</span>   <span class="co">ENV</span>[<span class="s"><span class="dl">&quot;</span><span class="k">RAILS_ENV</span><span class="dl">&quot;</span></span>] ||= <span class="s"><span class="dl">'</span><span class="k">test</span><span class="dl">'</span></span>
<span class="no"> 9</span>   require <span class="co">File</span>.expand_path(<span class="s"><span class="dl">&quot;</span><span class="k">../../config/environment</span><span class="dl">&quot;</span></span>, <span class="pc">__FILE__</span>)
<span class="no"><strong>10</strong></span>   require <span class="s"><span class="dl">'</span><span class="k">rspec/rails</span><span class="dl">'</span></span>     
<span class="no">11</span>   require <span class="s"><span class="dl">'</span><span class="k">capybara/rails</span><span class="dl">'</span></span>
<span class="no">12</span>   
<span class="no">13</span>   <span class="co">Dir</span>[<span class="co">Rails</span>.root.join(<span class="s"><span class="dl">&quot;</span><span class="k">spec/support/**/*.rb</span><span class="dl">&quot;</span></span>)].each {|f| require f}
<span class="no">14</span> 
<span class="no">15</span>   <span class="co">RSpec</span>.configure <span class="r">do</span> |config|
<span class="no">16</span>     config.mock_with <span class="sy">:rspec</span>    
<span class="no">17</span> 
<span class="no">18</span>     <span class="c">#Add this following line to get spork working with rails 3</span>
<span class="no">19</span>     <span class="co">ActiveSupport</span>::<span class="co">Dependencies</span>.clear
<span class="no"><strong>20</strong></span>   <span class="r">end</span>
<span class="no">21</span> 
<span class="no">22</span> <span class="r">end</span>
<span class="no">23</span> 
<span class="no">24</span> <span class="co">Spork</span>.each_run <span class="r">do</span>
<span class="no">25</span>   <span class="c"># This code will be run each time you run your specs.</span>
<span class="no">26</span> 
<span class="no">27</span>   load <span class="s"><span class="dl">&quot;</span><span class="il"><span class="idl">#{</span><span class="co">Rails</span>.root<span class="idl">}</span></span><span class="k">/config/routes.rb</span><span class="dl">&quot;</span></span>
<span class="no">28</span>   <span class="co">Dir</span>[<span class="s"><span class="dl">&quot;</span><span class="il"><span class="idl">#{</span><span class="co">Rails</span>.root<span class="idl">}</span></span><span class="k">/app/**/*.rb</span><span class="dl">&quot;</span></span>].each { |f| load f }
<span class="no">29</span> 
<span class="no"><strong>30</strong></span> <span class="r">end</span>           
</pre></div>
</div>
</div>

<p>In order to configure Rspec to always use Spork we need to edit mongoid-spork-example/.rspec. Create it if it doesn’t exist.</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> --colour
<span class="no">2</span> --drb
</pre></div>
</div>
</div>

<p>We have everything setup now. Let run the tests! Open new tab and go to the directory where you have your app. Start Spork.            </p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> $ spork
</pre></div>
</div>
</div>

<p>Now run the tests from another tab.</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="no">1</span> $ rspec spec 
</pre></div>
</div>
</div>

<p>Instant start ^_^</p>
		                              				
	</div>	                                              	
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'nerian-blog';

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
Configuration                                                                                                  			
		</div>                                                                                                             				
	</div>   	
</div>     
   		
		<script type="text/javascript">

		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-20768366-1']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();

		</script>    	       				
    </body>
</html>