<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<meta content='Freelance Web Developer for Ruby' name='description' /> 
	    <meta content='gonzalo rodriguez-baltanas diaz, ruby, freelance, mongodb' name='keywords' />
        <title>Nerian Blog: Lighting fast tests with Spork on a Mongoid project</title>
        <link rel="stylesheet" href="/css/master.css">
		<link rel="stylesheet" href="/css/coderay.css">
    </head>
    <body>        
	
		<div id="wrapper">          
	<div id="header">       	   
		<div id='actions'>
			<ul>
				<li><a href="/index.html">Blog</a></li>
				<li><a href="/about.html">Hire me</a></li>
				<li>
					<a href="http://feeds.feedburner.com/Nerian-blog" 
					target='_blank' 
					type="application/rss+xml">					
					Subscribe</a>
				</li>				
			</ul>
		</div>		                                                                     
	</div>                                                 	
	<div id="content">                                     
		<div class='post'>
			<div>
	<h2><a href="/2011/02/28/RPS-3-spork_and_mongoid.html">Lighting fast tests with Spork on a Mongoid project</a></h2>
	<br/>
	<div>
		<h3 id="summary">Summary:</h3>

<ul>
  <li>We are going to set up a Rails 3 project using Mongoid and Spork.</li>
  <li>The full project is in <a href="https://github.com/Nerian/Mongoid-spork-Rails-app-example" title="github">github</a></li>
</ul>

<h3 id="introduction">Introduction:</h3>

<p>MongoDB is a document oriented database. To sum it up what it means: Flexibility. </p>

<p>Mongoid is a ODM that harness the power of MongoDB in a very elegant way. Its power lies around a very good documentation and an active community.</p>

<p>Spork is a gem designed to allow you to run your spec very quickly. How does it do that? It preloads your Rails environment. You’ll notice a difference in that your testing starts right away, instead of waiting a few seconds.</p>

<h3 id="create-a-rails-project">Create a Rails project:</h3>

<div><div class="CodeRay">
  <div class="code"><pre>$ rails new mongoid-spork-example
</pre></div>
</div>
</div>

<p>Configure RVM       </p>

<div><div class="CodeRay">
  <div class="code"><pre>$ cd mongoid-spork-example
$ echo &quot;rvm gemset create mongoid-example \nrvm gemset use mongoid-example&quot; &gt;&gt; .rvmrc
</pre></div>
</div>
</div>

<p>Configure Gemfile      </p>

<div><div class="CodeRay">
  <div class="code"><pre>gem <span class="string"><span class="delimiter">'</span><span class="content">rails</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">3.0.4</span><span class="delimiter">'</span></span>                                                     
gem <span class="string"><span class="delimiter">&quot;</span><span class="content">mongoid</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">2.0.0.rc.7</span><span class="delimiter">&quot;</span></span>
gem <span class="string"><span class="delimiter">'</span><span class="content">bson_ext</span><span class="delimiter">'</span></span>
group <span class="symbol">:development</span>, <span class="symbol">:test</span> <span class="keyword">do</span>
  gem <span class="string"><span class="delimiter">'</span><span class="content">rspec-rails</span><span class="delimiter">'</span></span>
  gem <span class="string"><span class="delimiter">'</span><span class="content">spork</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">~&gt; 0.9.0.rc</span><span class="delimiter">'</span></span> <span class="comment"># It's important to use the rc version </span>
<span class="keyword">end</span>              
</pre></div>
</div>
</div>

<p>Install gems</p>

<div><div class="CodeRay">
  <div class="code"><pre>$ bundle install       
</pre></div>
</div>
</div>

<p>Generate mongoid configuration file:</p>

<div><div class="CodeRay">
  <div class="code"><pre>$ rails generate mongoid:config
</pre></div>
</div>
</div>

<p>Empty config/database.yml</p>

<p>Open config/application and comment the line require ‘rails/all’. Add the rest:</p>

<div><div class="CodeRay">
  <div class="code"><pre><span class="comment">#require 'rails/all' </span>
require <span class="string"><span class="delimiter">&quot;</span><span class="content">action_controller/railtie</span><span class="delimiter">&quot;</span></span>
require <span class="string"><span class="delimiter">&quot;</span><span class="content">action_mailer/railtie</span><span class="delimiter">&quot;</span></span>
require <span class="string"><span class="delimiter">&quot;</span><span class="content">active_resource/railtie</span><span class="delimiter">&quot;</span></span>
require <span class="string"><span class="delimiter">&quot;</span><span class="content">rails/test_unit/railtie</span><span class="delimiter">&quot;</span></span>  
</pre></div>
</div>
</div>

<p>Run RSpec generator</p>

<div><div class="CodeRay">
  <div class="code"><pre>rails g rspec:install
</pre></div>
</div>
</div>

<p>Run the Spork generator. This changes the spec/spec_helper.rb</p>

<div><div class="CodeRay">
  <div class="code"><pre>$ spork --bootstrap          
</pre></div>
</div>
</div>

<p>Configure spec/spec_helper.rb</p>

<div><div class="CodeRay">
  <div class="code"><pre>require <span class="string"><span class="delimiter">'</span><span class="content">rubygems</span><span class="delimiter">'</span></span>
require <span class="string"><span class="delimiter">'</span><span class="content">spork</span><span class="delimiter">'</span></span>

<span class="constant">Spork</span>.prefork <span class="keyword">do</span>
  <span class="comment"># Loading more in this block will cause your tests to run faster. However,</span>
  <span class="comment"># if you change any configuration or code from libraries loaded here, you'll</span>
  <span class="comment"># need to restart spork for it take effect.</span>
  <span class="predefined-constant">ENV</span>[<span class="string"><span class="delimiter">&quot;</span><span class="content">RAILS_ENV</span><span class="delimiter">&quot;</span></span>] ||= <span class="string"><span class="delimiter">'</span><span class="content">test</span><span class="delimiter">'</span></span>
  require <span class="constant">File</span>.expand_path(<span class="string"><span class="delimiter">&quot;</span><span class="content">../../config/environment</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">__FILE__</span>)
  require <span class="string"><span class="delimiter">'</span><span class="content">rspec/rails</span><span class="delimiter">'</span></span>     
  require <span class="string"><span class="delimiter">'</span><span class="content">capybara/rails</span><span class="delimiter">'</span></span>
  
  <span class="constant">Dir</span>[<span class="constant">Rails</span>.root.join(<span class="string"><span class="delimiter">&quot;</span><span class="content">spec/support/**/*.rb</span><span class="delimiter">&quot;</span></span>)].each {|f| require f}

  <span class="constant">RSpec</span>.configure <span class="keyword">do</span> |config|
    config.mock_with <span class="symbol">:rspec</span>    

    <span class="comment">#Add this following line to get spork working with rails 3</span>
    <span class="constant">ActiveSupport</span>::<span class="constant">Dependencies</span>.clear
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="constant">Spork</span>.each_run <span class="keyword">do</span>
  <span class="comment"># This code will be run each time you run your specs.</span>

  load <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">#{</span><span class="constant">Rails</span>.root<span class="inline-delimiter">}</span></span><span class="content">/config/routes.rb</span><span class="delimiter">&quot;</span></span>
  <span class="constant">Dir</span>[<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">#{</span><span class="constant">Rails</span>.root<span class="inline-delimiter">}</span></span><span class="content">/app/**/*.rb</span><span class="delimiter">&quot;</span></span>].each { |f| load f }

<span class="keyword">end</span>           
</pre></div>
</div>
</div>

<p>In order to configure Rspec to always use Spork we need to edit mongoid-spork-example/.rspec. Create it if it doesn’t exist.</p>

<div><div class="CodeRay">
  <div class="code"><pre>--colour
--drb
</pre></div>
</div>
</div>

<p>We have everything setup now. Let run the tests! Open new tab and go to the directory where you have your app. Start Spork.            </p>

<div><div class="CodeRay">
  <div class="code"><pre>$ spork
</pre></div>
</div>
</div>

<p>Now run the tests from another tab.</p>

<div><div class="CodeRay">
  <div class="code"><pre>$ rspec spec 
</pre></div>
</div>
</div>

<p>Instant start ^_^</p>
	
		<br/>
    <br/>
    <em>Posted on 28 February 2011</em>	                              				
	</div>	                                              	
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	var disqus_shortname = 'nerian-blog';

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = 'unique_dynamic_id_1234';
    // var disqus_url = 'http://example.com/permalink-to-page.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>                                                                                                  			
		</div>                                                                                                             				
	</div>
	<div id="footer">       	   
		<a href="/about.html">Hire a great web developer</a>
	</div>   	
</div>     
   		
    <script type="text/javascript">
      var _gauges = _gauges || [];
      (function() {
        var t   = document.createElement('script');
        t.type  = 'text/javascript';
        t.async = true;
        t.id    = 'gauges-tracker';
        t.setAttribute('data-site-id', '4f3c0864cb25bc666100000b');
        t.src = '//secure.gaug.es/track.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(t, s);
      })();
    </script>  	       				
    </body>  
</html>